version: 2.1
executors:
    docker-publisher:
        environment:
            IMAGE_NAME: gnuton/vitasdk-docker
            DOCKER_TAG: '$(date +%Y%m%d)'
        docker:
            - {image: 'circleci/buildpack-deps:stretch'}
jobs:
    build:
        executor: docker-publisher
        steps:
            - checkout
            - setup_remote_docker
            - {run: {name: 'Build Docker image', command: 'docker build -t $IMAGE_NAME:latest .'}}
            - {run: {name: 'Archive Docker image', command: 'docker save -o image $IMAGE_NAME'}}
            - {persist_to_workspace: {root: ., paths: [./image.tar]}}
    publiss:
        executor: docker-publisher
        steps:
            - {attach_workspace: {at: /tmp/workspace}}
            - setup_remote_docker
            - {run: {name: 'Load archived Docker image', command: 'docker load -i /tmp/workspace/image.tar'}}
            - {run: {name: 'Publish Docker Latest Image to Docker Hub', command: "echo \"$DOCKERHUB_PASS\" | docker login -u \"$DOCKERHUB_USERNAME\" --password-stdin\ndocker push $IMAGE_NAME:latest\n"}}
            - {run: {name: 'Publish Docker Tagged Image to Docker Hub', command: "echo \"$DOCKERHUB_PASS\" | docker login -u \"$DOCKERHUB_USERNAME\" --password-stdin\ndocker push $IMAGE_NAME:$DOCKER_TAG\n"}}
workflows:
    version: 2
    build-master:
        jobs:
            - {build: {filters: {branches: {only: master}}}}
            - {publish: {requires: [build], filters: {branches: {only: master}}}}
    build-master-nightly:
        jobs:
            - {build: {filters: {branches: {only: master}}}}
            - {publish: {requires: [build], filters: {branches: {only: master}}}}
        triggers:
            - {schedule: {cron: '0 0 * * *', filters: {branches: {only: master}}}}

